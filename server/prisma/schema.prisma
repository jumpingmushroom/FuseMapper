generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Panel {
  id        String   @id @default(cuid())
  name      String
  location  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Main breaker properties (panel-level)
  mainBreakerAmperage     Int?     @map("main_breaker_amperage")
  mainBreakerType         String?  @map("main_breaker_type")
  mainBreakerPoles        Int      @default(2) @map("main_breaker_poles")
  mainBreakerCurveType    String?  @map("main_breaker_curve_type")
  mainBreakerManufacturer String?  @map("main_breaker_manufacturer")
  mainBreakerModel        String?  @map("main_breaker_model")
  mainBreakerNotes        String?  @map("main_breaker_notes")
  mainBreakerDeviceUrl    String?  @map("main_breaker_device_url")
  mainBreakerColor        String?  @map("main_breaker_color")
  mainBreakerIsActive     Boolean  @default(true) @map("main_breaker_is_active")

  // Sub-panel properties
  parentFuseId String? @unique @map("parent_fuse_id")
  feedAmperage Int?    @map("feed_amperage")

  rows        Row[]
  fuses       Fuse[]
  parentFuse  Fuse?  @relation("SubPanel", fields: [parentFuseId], references: [id], onDelete: SetNull)

  @@map("panels")
}

model Row {
  id        String   @id @default(cuid())
  panelId   String   @map("panel_id")
  label     String?
  position  Int      @default(0)
  maxFuses  Int      @default(10) @map("max_fuses")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  panel Panel  @relation(fields: [panelId], references: [id], onDelete: Cascade)
  fuses Fuse[]

  @@unique([panelId, position])
  @@map("rows")
}

model Fuse {
  id           String   @id @default(cuid())
  panelId      String   @map("panel_id")
  rowId        String?  @map("row_id")
  label        String?
  sortOrder    Int      @default(0) @map("sort_order")
  slotNumber   Int?     @map("slot_number")
  poles        Int      @default(1)
  amperage     Int?
  type         String   @default("MCB")
  curveType    String?  @map("curve_type")
  manufacturer String?
  model        String?
  isActive     Boolean  @default(true) @map("is_active")
  color        String?
  notes        String?
  deviceUrl    String?  @map("device_url")
  // SPD-specific fields
  spdVoltageRating       Int?    @map("spd_voltage_rating")
  spdSurgeCurrentRating  Int?    @map("spd_surge_current_rating")
  spdClass               String? @map("spd_class")
  // NEK 400:2022 ยง 514.5.1 required fields
  cableCrossSection      String? @map("cable_cross_section")
  circuitLength          Int?    @map("circuit_length")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  panel            Panel         @relation(fields: [panelId], references: [id], onDelete: Cascade)
  row              Row?          @relation(fields: [rowId], references: [id], onDelete: SetNull)
  sockets          Socket[]
  junctionBoxes    JunctionBox[]
  hardwiredDevices Device[]
  subPanel         Panel?        @relation("SubPanel")

  @@unique([panelId, slotNumber])
  @@map("fuses")
}

model JunctionBox {
  id        String   @id @default(cuid())
  fuseId    String   @map("fuse_id")
  label     String?
  sortOrder Int      @default(0) @map("sort_order")
  roomId    String?  @map("room_id")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  fuse    Fuse     @relation(fields: [fuseId], references: [id], onDelete: Cascade)
  room    Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)
  sockets Socket[]
  devices Device[]

  @@map("junction_boxes")
}

model Socket {
  id            String       @id @default(cuid())
  fuseId        String?      @map("fuse_id")
  junctionBoxId String?      @map("junction_box_id")
  label         String?
  sortOrder     Int          @default(0) @map("sort_order")
  roomId        String?      @map("room_id")
  notes         String?
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  fuse        Fuse?        @relation(fields: [fuseId], references: [id], onDelete: Cascade)
  junctionBox JunctionBox? @relation(fields: [junctionBoxId], references: [id], onDelete: Cascade)
  room        Room?        @relation(fields: [roomId], references: [id], onDelete: SetNull)
  devices     Device[]

  @@map("sockets")
}

model Device {
  id               String       @id @default(cuid())
  socketId         String?      @map("socket_id")
  fuseId           String?      @map("fuse_id")
  junctionBoxId    String?      @map("junction_box_id")
  name             String
  icon             String       @default("generic")
  category         String       @default("other")
  roomId           String?      @map("room_id")
  estimatedWattage Int?         @map("estimated_wattage")
  isHardwired      Boolean      @default(false) @map("is_hardwired")
  notes            String?
  sortOrder        Int          @default(0) @map("sort_order")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  socket      Socket?      @relation(fields: [socketId], references: [id], onDelete: SetNull)
  fuse        Fuse?        @relation(fields: [fuseId], references: [id], onDelete: Cascade)
  junctionBox JunctionBox? @relation(fields: [junctionBoxId], references: [id], onDelete: Cascade)
  room        Room?        @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@map("devices")
}

model Room {
  id        String   @id @default(cuid())
  name      String
  code      String?  // Room abbreviation (KIT, LR, GAR, etc.)
  color     String   @default("#6B7280")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sockets       Socket[]
  junctionBoxes JunctionBox[]
  devices       Device[]

  @@map("rooms")
}
